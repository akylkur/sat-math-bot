# Analytics Setup Guide

## Что было добавлено

### 1. SQL Схема (`schema.sql`)
- Таблица `users` - информация о пользователях
- Таблица `events` - все события (user_start, question_sent, answer_submitted)
- Таблица `attempts` - попытки решения задач с результатами
- Индексы для оптимизации запросов

### 2. Модуль `db.py`
- Async функции для работы с PostgreSQL через asyncpg
- Все функции устойчивы к ошибкам БД (не падают, если БД недоступна)
- Функции аналитики:
  - `get_dau_today()` - DAU за сегодня (UTC+6)
  - `get_attempts_today()` - попытки сегодня
  - `get_attempts_total()` - попытки всего
  - `get_accuracy()` - общая точность
  - `get_attempts_per_day(days=14)` - попытки по дням
  - `get_top_users_last_7_days(limit=10)` - топ пользователей
  - `get_retention_d1()` - retention D1

### 3. Изменения в `main.py`

#### Логирование событий:
- **`start_handler`** → логирует `user_start` + создаёт/обновляет пользователя
- **`send_question_universal`** → логирует `question_sent` при отправке вопроса
- **`answer_handler`** → логирует `attempt` (в таблицу attempts) + `answer_submitted` (в events)
- **`fallback_handler`** → логирует `user_start` для новых пользователей

#### Admin команды:
- **`/admin_stats`** - краткая статистика:
  - DAU сегодня
  - Попытки сегодня
  - Попытки всего
  - Accuracy
- **`/admin_daily`** - попытки по дням за последние 14 дней

Доступ к admin командам ограничен через `ADMIN_ID` из ENV.

## Установка

### 1. Создать базу данных
Используйте Railway или Supabase для создания PostgreSQL базы данных.

### 2. Выполнить SQL схему
Скопируйте содержимое `schema.sql` и выполните в SQL редакторе вашей БД.

### 3. Установить зависимости
```bash
pip install -r requirements.txt
```

### 4. Настроить переменные окружения
Добавьте в `.env` или в настройках Railway:
```
DATABASE_URL=postgresql://user:password@host:port/database
BOT_TOKEN=your_bot_token
ADMIN_ID=your_telegram_user_id
```

### 5. Запустить бота
Бот автоматически инициализирует подключение к БД при старте.

## Использование

### Для пользователей
Все события логируются автоматически. Никаких дополнительных действий не требуется.

### Для администратора
1. Узнайте свой Telegram user_id (можно через @userinfobot)
2. Установите `ADMIN_ID` в переменные окружения
3. Используйте команды:
   - `/admin_stats` - текущая статистика
   - `/admin_daily` - график попыток за 14 дней

## Устойчивость к ошибкам

- Если `DATABASE_URL` не установлен, аналитика отключается, бот продолжает работать
- Если БД недоступна, все функции логирования возвращают `False`/пустые значения, но не падают
- Бот работает даже если БД полностью недоступна

## Метрики

Все метрики считаются в часовом поясе UTC+6 (Кыргызстан):
- DAU - уникальные пользователи за день
- Попытки - все записи в таблице `attempts`
- Accuracy - (правильные / всего) * 100%
- Retention D1 - % пользователей, вернувшихся на следующий день после первого визита

